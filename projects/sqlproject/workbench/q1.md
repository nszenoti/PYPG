Que1
---
Find the total number of customers who have placed orders. What is the distribution of the customers across states? [4 marks]
> Hint: For each state, count the number of customers

---

### 1. Total number of customers who placed orders

```sql
SELECT
    COUNT(DISTINCT customer_id) as total_customers
FROM order_t;
```
> ans : 994


### 2. Distribution of the customers across states

```sql
SELECT
    state,
    COUNT(*) AS customer_count
FROM customer_t
GROUP BY state
ORDER BY customer_count DESC;
```

### 3. Distribution of the customers across states, who placed the orders

**Option 1** (SubQuery)

```sql
SELECT
    c.state,
    COUNT(DISTINCT o.customer_id) as customers_count,
    ROUND(COUNT(DISTINCT o.customer_id) * 100.0 / (SELECT COUNT(DISTINCT customer_id) FROM order_t), 2) as percentage
FROM order_t o
JOIN customer_t c ON c.customer_id = o.customer_id
GROUP BY c.state
ORDER BY customers_count DESC;
```

**Option 2** (CTE) âœ…

```sql
WITH
total_count AS (
    SELECT COUNT(DISTINCT customer_id) AS total_customers FROM order_t
),
customer_counts AS (
    SELECT
        c.state,
        COUNT(DISTINCT o.customer_id) AS customers_count
    FROM order_t o
    JOIN customer_t c ON c.customer_id = o.customer_id
    GROUP BY c.state
)
SELECT
    cc.state,
    cc.customers_count,
    ROUND(cc.customers_count * 100.0 / tc.total_customers, 2) AS percentage
FROM customer_counts cc, total_count tc
ORDER BY customers_count DESC;
```

> Cross join works here because we want to combine each state's count with the same total value

#### NOTE:

Looking at this CTE approach:

This is actually more optimized because:
1. Calculates total count once and reuses it
2. Avoids the subquery in SELECT clause
3. Separates concerns clearly (total count vs state-wise distribution)

> this CTE version is better than my direct aggregation approach

---

## Observations

1. California and Texas are tied as the leading markets, each contributing nearly 10% of total ordering customers.
2. Florida and New York follow closely, while District of Columbia represents a smaller but notable segment.
3. Top 4 states (CA, TX, FL, NY) account for ~35% of all ordering customers, showing high geographic concentration
4. Notable drop between NY (6.94%) and DC (3.52%), suggesting a clear tier difference between major and mid-size markets

- This distribution suggests focusing resources and marketing efforts on maintaining dominance in the top states (ie california, texas, ...) while exploring growth opportunities in mid-tier markets.
- Also a potential to expand reach in underperforming regions (such as mississippi, north dakota, ...)