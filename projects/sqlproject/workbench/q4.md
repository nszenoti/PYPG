# Question 4:
-- Find the overall average rating given by the customers. What is the average rating in each quarter? [5 marks]

Consider the following mapping for ratings:
“Very Bad”: 1, “Bad”: 2, “Okay”: 3, “Good”: 4, “Very Good”: 5

> Hint: Use subquery and assign numerical values to feedback categories using a CASE statement.
> Then, calculate the average feedback count per quarter. Use a subquery to convert feedback into numerical values and group by quarter_number to compute the average.


---

### Technique/Concepts

1. Union All (Manual)
2. RollUp (Automatic)

**Mindset of Query Design**

1. First convert text ratings to numbers (CASE is perfect for fixed mapping)
2. Need both overall + quarterly averages → single result set → UNION ALL makes sense
3. Will reuse rating conversion multiple times → CTE is cleaner than repeating subqueries
4. Natural ordering: Overall first, then Q1 to Q4 → simple ORDER BY handles this

That's it - just 4 key thought points that naturally led to our query structure. Please share the results!

**Why UnionAll** ?

UNION ALL combines:

1. First query: single row (overall average for all data)
   - Just one row with 'Overall' and its avg_rating
2. Second query: multiple rows (one per quarter)
   - Each quarter with its avg_rating
   - Number of rows = number of quarters in data

We use UNION ALL (not UNION) because:
- Rows are guaranteed to be unique (Overall vs Q1,Q2,etc)
- No need for expensive duplicate removal
- Preserves all rows as intended

---

## Query

Check if any values alternative case exists
```sql
select
distinct customer_feedback
from order_t
```
> { Very Bad, Bad, Okay, Good, Very Good }  // Output

> Note if there exists diff case version then we may need to use lower() or upper() in case clause !

### **Ans1**

Below answer compute manually the overall value

```sql
WITH feedback_ratings AS (
    SELECT
        quarter_number,
        CASE customer_feedback
            WHEN 'Very Bad' THEN 1
            WHEN 'Bad' THEN 2
            WHEN 'Okay' THEN 3
            WHEN 'Good' THEN 4
            WHEN 'Very Good' THEN 5
        END as rating_score
    FROM order_t
    WHERE customer_feedback IS NOT NULL
)
SELECT
    'Overall' as period,
    ROUND(AVG(rating_score), 2) as avg_rating
FROM feedback_ratings
UNION ALL
SELECT
    CONCAT('Quarter ', quarter_number) as period,
    ROUND(AVG(rating_score), 2) as avg_rating
FROM feedback_ratings
GROUP BY quarter_number
ORDER BY period;
```

### Ans2 ✅

```sql
WITH feedback_ratings AS (
    SELECT
        quarter_number,
        CASE customer_feedback
            WHEN 'Very Bad' THEN 1
            WHEN 'Bad' THEN 2
            WHEN 'Okay' THEN 3
            WHEN 'Good' THEN 4
            WHEN 'Very Good' THEN 5
            ELSE NULL
        END AS rating_score
    FROM order_t
    WHERE customer_feedback IS NOT NULL
)
SELECT
    COALESCE(CONCAT('Quarter ', quarter_number), 'Overall') AS period,
    ROUND(AVG(rating_score), 2) AS avg_rating
FROM feedback_ratings
GROUP BY quarter_number WITH ROLLUP;
```

✅ **Explanation of What This Does:**

* `feedback_ratings` CTE transforms feedback text → numeric rating.
* `GROUP BY quarter_number WITH ROLLUP` gives:

  * **Quarter-wise average** (`quarter_number` = 1,2,3,4)
  * **Overall average** in the row where `quarter_number` = `NULL`.

---

**Result**

```
| Period     | Avg Rating |
|------------|------------|
| Quarter 1  | 3.55       |
| Quarter 2  | 3.35       |
| Quarter 3  | 2.96       |
| Quarter 4  | 2.40       |
| Overall    | 3.14       |
```

---

#### 🔧 **Techniques Used:**

* **CASE Statement** to map textual feedback to numeric ratings (1–5 scale).
* **CTE** (`feedback_ratings`) for modularity and clarity.
* **`GROUP BY WITH ROLLUP`** to compute both **quarter-wise** and **overall** averages in a single query.
* **`ROUND()`** to limit decimal precision to 2 places.

---

## Observations/Insights


#### 📊 **Key Insights:**

1. Clear declining trend in customer satisfaction:
    - Q1 started strong (3.55)
    - Each quarter shows progressive decline
    - Q4 significantly lower (2.40)
2. **Overall average rating is just 3.14** (between *Okay* and *Good*), hinting at **moderate service quality**.
3. The drop from Q1 to Q4 could reflect **deteriorating after-sales service**, **shipping issues**, or **customer experience degradation** over time.

**Critical insight**: ~30% drop in satisfaction from Q1 (3.55) to Q4 (2.40) suggests serious service quality issues that need immediate attention

---

#### 💡 **Business Implications / Recommendations:**

* Immediate need to investigate **what changed across quarters** — possibly in shipping, service response, or vendor quality.
* Conduct a deeper **driver analysis** for negative feedback (esp. Q3 & Q4) to prioritize **corrective actions**.
* Consider launching **customer retention or apology campaigns** to rebuild trust in low-rating cohorts.


