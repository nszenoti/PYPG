# Question 3:

Which is the most preferred vehicle maker in each state? [4 marks]
> Hint: Use the window function RANK() to rank based on the count of customers for each state and vehicle maker.
> After ranking, take the vehicle maker whose rank is 1.

---

### ✅ **Step 1: Understand the Requirement**

We need to find:

* For **each state**, the **most preferred vehicle maker** based on the **number of customers** (unique) who purchased it.
* This is a **per-group top-N** problem (top 1 per state).

---

### ✅ **Step 2: Identify the Best Technique**

To solve a "top-1 per group" problem, **two standard options**:

1. **Window Function** (`RANK()` or `ROW_NUMBER()` over partition by state, order by customer count desc) → ✅ scalable, flexible.
2. **Correlated subquery** or aggregation + join → also works, but **less flexible** if ties need to be handled.

✅ Given we may have **ties** (two vehicle makers equally preferred), the use of **`RANK()`** is **justified and appropriate** here.

---

### ✅ **Step 3: SQL Query**

```sql
WITH vehicle_preference AS (
    SELECT
        c.state,
        p.vehicle_maker,
        COUNT(DISTINCT o.customer_id) AS customer_count,
        RANK() OVER (
            PARTITION BY c.state
            ORDER BY COUNT(DISTINCT o.customer_id) DESC
        ) AS position
    FROM order_t o
    JOIN customer_t c ON o.customer_id = c.customer_id
    JOIN product_t p ON o.product_id = p.product_id
    GROUP BY c.state, p.vehicle_maker
)
SELECT
    state,
    vehicle_maker as top_vehicle_maker,
    customer_count
FROM vehicle_preference
WHERE position = 1
--ORDER BY state;
--ORDER BY customer_count DESC;
```

> REMEMBER:
> it's absolutely possible to have ties - multiple vehicle makers could have the same customer count in a state.
> In this case, RANK() would give the same rank (1) to tied makers, which is exactly what we want to see

---
**Concepts entailed:**

- Used JOINs to bring together customer, order, and product data.
- Applied `COUNT(DISTINCT customer_id)` per state and vehicle_maker
- Used RANK() as a window function over PARTITION BY state ORDER BY customer_count DESC to find top-ranked makers per state.
- Selected only records where rank = 1.


---

## Observations/Insights

> Using RANK() was crucial as it revealed these important market share ties that would have been hidden with ROW_NUMBER()

**Observations**

- California has a perfect 5-way tie (Nissan, Ford, Dodge, Chevrolet, Audi) with 6 customers each
- Arizona has a 2-way tie (Cadillac, Pontiac) with 3 customers each
- Arkansas shows 6-way tie with 1 customer each

Market dynamics vary significantly
- Some states have clear leaders (Colorado: Chevrolet with 5 customers)
- Some states show highly fragmented preferences (Arkansas with 6 different makers tied)

**Business Insights**:

1. **Preferences vary widely by state** — even within a state like California, there’s a **tie among 5 brands** with equal popularity.
2. States like **Arkansas** show **diverse, evenly split preferences** — no dominant brand, suggesting a fragmented market.
3. Using this insight, **regional marketing campaigns** can be tailored to focus on each state’s leading brands or tackle fragmented preferences with targeted promotions.

> This data suggests highly varied brand preferences across states, with some markets being highly competitive (multiple tied brands) and others having clear leaders.

---